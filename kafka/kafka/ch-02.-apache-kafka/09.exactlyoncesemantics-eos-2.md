# 09.ExactlyOnceSemantics(EOS)2

## Transaction

#### Transaction을 구현하기 위해, 몇 가지 새로운 개념들이 도입

* Transaction Coordinator Consumer Group Coordinator와 비슷하게, 각 Producer에게는 Transaction Coordinator가 할당되며, PID 할당 및 Transaction 관리의 모든 로직을 수행
* Transaction Log 새로운 Internal Kafka Topic으로써, Consumer Offset Topic과 유사하게, 모든 Transaction의 영구적이고 복제된 Record를 저장하는 Transaction Coordinator의 상태 저장소
* TransactionalId Producer를 고유하게 식별하기 위해 사용되며, 동일한 TransactionalId를 가진 Producer의 다른 인스턴스들은 이전 인스턴스에 의해 만들어진 모든 Transaction을 재개(또는 중단)할 수 있음

## Broker Configs

| Parameter                                | Description                                                                                                                                                                                                                                      | Default            |
| ---------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------ |
| transactional.id.timeout.ms              | Transaction Coordinator가 Producer TransactionalId로부터 Transaction 상태 업데이트를 수신하지 않고 사전에 만료되기 전에 대기하는 최대 시간(ms)                                                                                                                                     | 604800000 (7 days) |
| max.transaction.timeout.ms               | <p></p><p>Transaction에 허용되는 최대 timeout 시간</p><ul><li>Client가 요청한 Transaction 시간이 이 시간을 초과하면 Broker는 InitPidRequest에서 InvalidTransactionTimeout 오류를 반환</li><li>Producer가 Transaction에 포함된 Topic에서 읽는 Consumer를 지연시킬 수 있는 너무 큰 시간 초과를 방지</li></ul> | 900000 (15 min)    |
| transaction.state.log.replication.factor | Transaction State Topic의 Replication Factor                                                                                                                                                                                                      | 3                  |
| transaction.state.log.num.partitions     | Transaction State Topic의 Partition 개수                                                                                                                                                                                                            | 50                 |
| transaction.state.log.min.isr            | Transaction State Topic의 min ISR 개수                                                                                                                                                                                                              | 2                  |
| transaction.state.log.segment.bytes      | Transaction State Topic의 Segment 크기                                                                                                                                                                                                              | 104857600 bytes    |



## Producer Configs

| Parameter              | Description                                                                                                                                                                                                                                                                                                                                                | Default        |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------- |
| enable.idempotence     | <ul><li>비활성화된 경우 Transaction 기능을 사용할 수 없음 </li><li>활성화(true)하고 acks=all, retries > 1, max.inflight.requests.per.connection=1 을 같이 사용해야 함</li></ul>                                                                                                                                                                                                         | false          |
| transaction.timeout.ms | <ul><li>Transaction Coordinator가 진행 중인 Transaction을 사전에 중단하기 전에 Producer의 Transaction 상태 업데이트를 기다리는 최대 시간(ms)</li><li>이 구성 값은 InitPidRequest와 함께 Transaction Coordinator에게 전송</li><li>이 값이 Broker의 max.transaction.timeout.ms 설정보다 크면 'InvalidTransactionTimeout' 오류와 함께 요청이 실패</li></ul>                                                                  | 60000 (60 sec) |
| transactional.id       | <ul><li>Transaction 전달에 사용할 TransactionalId</li><li>이를 통해 클라이언트는 새로운 Transaction을 시작하기 전에 동일한 TransactionalId를 사용하는 Transaction이 완료되었음을 보장할 수 있으므로 여러 Producer session에 걸쳐 있는 안정성 의미 체계를 사용할 수 있음</li><li>TransactionalId가 비어있으면(default), Producer는 Idempotent Delivery 만으로 제한</li><li>TransactionalId가 구성된 경우, 반드시 enable.idempotence를 활성화해야 함</li></ul> | 없음             |



## Consumer Configs



| Parameter          | Description                                                                                                                                                              | Default           |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------- |
| isolation.level    | <ul><li>read_uncommitted: Offset 순서로 Commit된 메시지와 Commit되지 않은 메시지를 모두 사용</li><li>read_committed: Non-Transaction 메시지 또는 Commit된 Transaction 메시지만 Offset 순서로 사용</li></ul> | read\_uncommitted |
| enable.auto.commit | false : Consumer Offset에 대한 Auto Commit 을 Off                                                                                                                            | true              |
|                    |                                                                                                                                                                          |                   |



